<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BTMS Playground</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:20px;line-height:1.4}
    h1{font-size:20px;margin:0 0 16px}
    section{border:1px solid #ddd;border-radius:8px;padding:12px;margin:12px 0}
    label{display:block;margin:6px 0 2px}
    input,select,button{padding:8px;margin:2px 0}
    button{cursor:pointer}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>div{min-width:220px}
    pre{background:#0b1020;color:#e8e8e8;padding:12px;border-radius:8px;overflow:auto}
  </style>
  <script>
    async function post(path, body) {
      const r = await fetch(path, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })
      const t = await r.text()
      let data = null
      try { data = JSON.parse(t) } catch { data = { raw: t } }
      return { ok: r.ok, status: r.status, data }
    }
    function log(s) {
      const el = document.getElementById('log')
      el.textContent = (typeof s === 'string') ? s : JSON.stringify(s, null, 2)
    }
    async function createTitle() {
      const name = document.getElementById('titleName').value
      const scope = document.getElementById('titleScope').value
      const res = await post('/api/admin/titles', { name: (name||'').trim(), scope })
      log(res.data || res)
    }
    async function listTitles() {
      const r = await fetch('/api/admin/titles')
      log(await r.json())
    }
    async function createRole() {
      const name = document.getElementById('roleName').value
      const perms = document.getElementById('rolePerms').value.split(',').map(s=>s.trim()).filter(Boolean)
      const parent = document.getElementById('roleParent').value || null
      const res = await post('/api/admin/roles', { name: (name||'').trim(), permissions: perms, parentRoleId: parent?Number(parent):null })
      log(res.data || res)
    }
    async function createPlayer(target) {
      const name = (document.getElementById(target+'Name').value || '').trim()
      const nat = (document.getElementById(target+'Nat').value || '').trim()
      const url = (document.getElementById(target+'Photo').value || '').trim()
      const res = await post('/api/players', { name, nationality: nat || null, photoUrl: url || null })
      log(res.data || res)
      const idField = document.getElementById(target+'Id')
      if (res && res.data && res.data.id) idField.value = res.data.id
    }
    async function createMatch() {
      const p1 = Number(document.getElementById('p1Id').value)
      const p2 = Number(document.getElementById('p2Id').value)
      const f = Number(document.getElementById('frames').value || 4)
      const res = await post('/api/matches', { playerIds: [p1,p2], framesPerMatch: f })
      log(res.data || res)
      if (res && res.data && res.data.id) document.getElementById('matchId').value = res.data.id
    }
    function parsePins(s) {
      if (!s) return []
      return s.split(',').map(x=>x.trim()).filter(x=>x.length>0).map(Number)
    }
    async function submitFrame() {
      const mid = Number(document.getElementById('matchId').value)
      const frameNo = Number(document.getElementById('frameNo').value)
      const p1 = Number(document.getElementById('p1Id').value)
      const p2 = Number(document.getElementById('p2Id').value)
      const pins1 = parsePins(document.getElementById('p1Pins').value)
      const pins2 = parsePins(document.getElementById('p2Pins').value)
      const res = await post(`/api/matches/${mid}/frames`, { frameNo, rolls: [ { playerId: p1, pins: pins1 }, { playerId: p2, pins: pins2 } ] })
      log(res.data || res)
    }
    async function ping() {
      const a = await fetch('/health').then(r=>r.json())
      const v = await fetch('/api/version').then(r=>r.json())
      log({ health:a, version:v })
    }
    window.addEventListener('DOMContentLoaded', ping)
  </script>
</head>
<body>
  <h1>BTMS Playground</h1>

  <section>
    <div class="row">
      <div><button onclick="ping()">健康檢查</button></div>
    </div>
  </section>

  <section>
    <h2>職銜</h2>
    <div class="row">
      <div><label>名稱</label><input id="titleName" placeholder="主裁判"></div>
      <div><label>範圍</label><select id="titleScope"><option value="official">official</option><option value="club">club</option></select></div>
      <div><label>&nbsp;</label><button onclick="createTitle()">新增職銜</button></div>
      <div><label>&nbsp;</label><button onclick="listTitles()">查看職銜</button></div>
    </div>
  </section>

  <section>
    <h2>角色</h2>
    <div class="row">
      <div><label>名稱</label><input id="roleName" placeholder="ClubAdmin"></div>
      <div><label>權限（逗號分隔）</label><input id="rolePerms" placeholder="competition:create"></div>
      <div><label>父角色ID（可空）</label><input id="roleParent" placeholder=""></div>
      <div><label>&nbsp;</label><button onclick="createRole()">新增角色</button></div>
    </div>
  </section>

  <section>
    <h2>球員</h2>
    <div class="row">
      <div><label>Player1 名稱</label><input id="p1Name" placeholder="Alex"></div>
      <div><label>國籍</label><input id="p1Nat" placeholder="HKG"></div>
      <div><label>照片URL</label><input id="p1Photo" placeholder="https://..."></div>
      <div><label>Player1 ID</label><input id="p1Id" placeholder=""></div>
      <div><label>&nbsp;</label><button onclick="createPlayer('p1')">建立 Player1</button></div>
    </div>
    <div class="row">
      <div><label>Player2 名稱</label><input id="p2Name" placeholder="Ben"></div>
      <div><label>國籍</label><input id="p2Nat" placeholder="HKG"></div>
      <div><label>照片URL</label><input id="p2Photo" placeholder="https://..."></div>
      <div><label>Player2 ID</label><input id="p2Id" placeholder=""></div>
      <div><label>&nbsp;</label><button onclick="createPlayer('p2')">建立 Player2</button></div>
    </div>
  </section>

  <section>
    <h2>比賽與入分</h2>
    <div class="row">
      <div><label>每場局數</label><input id="frames" value="4"></div>
      <div><label>&nbsp;</label><button onclick="createMatch()">建立比賽</button></div>
      <div><label>Match ID</label><input id="matchId" placeholder=""></div>
    </div>
    <div class="row">
      <div><label>第幾局</label><input id="frameNo" value="1"></div>
      <div><label>Player1 Pins</label><input id="p1Pins" placeholder="10 或 7,3"></div>
      <div><label>Player2 Pins</label><input id="p2Pins" placeholder="10 或 7,3"></div>
      <div><label>&nbsp;</label><button onclick="submitFrame()">上傳此局</button></div>
    </div>
  </section>

  <section>
    <h2>響應</h2>
    <pre id="log">等待操作…</pre>
  </section>
</body>
</html>
