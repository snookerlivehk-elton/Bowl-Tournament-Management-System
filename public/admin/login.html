<!doctype html>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>管理登入</title>
<style>
body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:16px}
.card{border:1px solid #ddd;border-radius:8px;padding:12px;margin:12px 0}
input,button{padding:10px;font-size:16px}
button{cursor:pointer}
.row{display:flex;gap:12px;flex-wrap:wrap}
.row>div{flex:1;min-width:180px}
#log{background:#0b1020;color:#e8e8e8;border-radius:8px;padding:10px;white-space:pre-wrap}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid #ddd;padding:8px;text-align:left}
</style>
<h2>管理登入</h2>
<div class="card" id="auth">
  <div class="row">
    <div><label>Email</label><br><input id="email" value=""></div>
    <div><label>Password</label><br><input id="password" type="password" value=""></div>
  </div>
  <div style="margin-top:10px">
    <button onclick="login()">登入</button>
    <button onclick="logout()">登出</button>
  </div>
  <div style="margin-top:10px">狀態：<span id="status">未登入</span></div>
</div>
<div class="card" id="clubs" style="display:none">
  <h3>球會管理</h3>
  <div class="row">
    <div><label>球會名稱</label><br><input id="clubName"></div>
    <div>
      <label>地區（可空）</label><br>
      <input id="clubRegion" list="regionOptions" placeholder="輸入代碼（如 HKG）">
      <datalist id="regionOptions"></datalist>
    </div>
  </div>
  <div style="margin-top:10px">
    <button onclick="createClub()">建立球會</button>
    <button onclick="loadClubs()">重新載入</button>
  </div>
  <div style="margin-top:10px">
    <table>
      <thead><tr><th>ID</th><th>名稱</th><th>地區</th><th>建立時間</th></tr></thead>
      <tbody id="clubTable"></tbody>
    </table>
  </div>
</div>
<div class="card" id="countries" style="display:none">
  <h3>國家代碼管理</h3>
  <div class="row">
    <div><label>代碼（ISO3）</label><br><input id="ctCode" placeholder="HKG"></div>
    <div><label>英文名稱</label><br><input id="ctName" placeholder="Hong Kong"></div>
    <div><label>本地名稱（可空）</label><br><input id="ctLocalName" placeholder="香港"></div>
    <div><label>旗幟 URL（可空）</label><br><input id="ctFlagUrl" placeholder="https://.../flag.png"></div>
  </div>
  <div style="margin-top:10px">
    <button onclick="createCountry()">新增國家代碼</button>
    <button onclick="loadCountries()">重新載入</button>
    <button onclick="updateCountry()">更新（依代碼）</button>
  </div>
  <div style="margin-top:10px">
    <input type="file" id="ctFlagFile" accept="image/png,image/jpeg,image/webp">
    <button onclick="uploadFlag()">上傳旗幟（依代碼）</button>
  </div>
  <div style="margin-top:10px">
    <table>
      <thead><tr><th>代碼</th><th>名稱</th><th>本地名稱</th><th>旗幟</th><th>操作</th></tr></thead>
      <tbody id="ctTable"></tbody>
    </table>
  </div>
</div>
<div class="card"><div id="log">等待操作…</div></div>
<script>
function log(x){document.getElementById('log').textContent=(typeof x==='string')?x:JSON.stringify(x,null,2)}
function token(){return localStorage.getItem('admin_token')||''}
function setToken(t){localStorage.setItem('admin_token', t)}
let countriesCache = []
function updateUI(){
  const t = token()
  document.getElementById('status').textContent = t ? '已登入' : '未登入'
  document.getElementById('clubs').style.display = t ? 'block' : 'none'
  document.getElementById('countries').style.display = t ? 'block' : 'none'
}
async function login(){
  const email = document.getElementById('email').value.trim()
  const password = document.getElementById('password').value
  try{
    const r = await fetch('/api/admin/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})})
    const d = await r.json()
    if(d.token){ setToken(d.token); updateUI(); log({login:'ok'}) ; loadClubs() } else { log(d) }
  }catch(e){ log('login error') }
}
function logout(){ localStorage.removeItem('admin_token'); updateUI(); log('已登出') }
async function authedFetch(url, opts){
  const h = Object.assign({}, (opts&&opts.headers)||{}, { 'Authorization':'Bearer '+token(), 'Content-Type':'application/json' })
  const r = await fetch(url, Object.assign({}, opts||{}, { headers: h }))
  if(!r.ok){
    const txt = await r.text()
    try{ log(JSON.parse(txt)) }catch{ log(txt) }
    throw new Error('request failed')
  }
  return r.json()
}
async function loadClubs(){
  try{
    const list = await authedFetch('/api/admin/clubs', { method:'GET' })
    const tbody = document.getElementById('clubTable')
    tbody.innerHTML = ''
    for(const c of list){
      const tr = document.createElement('tr')
      tr.innerHTML = `<td>${c.id}</td><td>${c.name}</td><td>${c.region||''}</td><td>${c.created_at||''}</td>`
      tbody.appendChild(tr)
    }
    log({clubs:list.length})
    // 同步更新地區下拉：優先使用 countries 清單
    try{
      countriesCache = await authedFetch('/api/admin/countries', { method:'GET' })
      const input = document.getElementById('clubRegion')
      const render = (q) => {
        const dl = document.getElementById('regionOptions')
        const query = (q||'').trim()
        const up = query.toUpperCase()
        const low = query.toLowerCase()
        const items = countriesCache.filter(ct =>
          !query ||
          ct.code.startsWith(up) ||
          (ct.name||'').toLowerCase().includes(low)
        )
        dl.innerHTML = ''
        for(const ct of items){
          const opt = document.createElement('option')
          opt.value = ct.code
          opt.label = `${ct.code} - ${ct.name}`
          dl.appendChild(opt)
        }
      }
      input.addEventListener('input', e => render(e.target.value))
      render(input.value)
    }catch(e){}
  }catch(e){}
}
async function createClub(){
  const name = document.getElementById('clubName').value.trim()
  const region = (document.getElementById('clubRegion').value || '').toUpperCase()
  if(!name){ log('name required'); return }
  const allowed = (countriesCache||[]).map(c=>c.code)
  const finalRegion = region ? (allowed.includes(region) ? region : null) : null
  if(region && !finalRegion){ log('請選擇列表中的國家代碼或留空'); return }
  try{
    const d = await authedFetch('/api/admin/clubs', { method:'POST', body: JSON.stringify({ name, region: finalRegion }) })
    log(d); loadClubs()
  }catch(e){}
}
async function loadCountries(){
  try{
    const list = await authedFetch('/api/admin/countries', { method:'GET' })
    const tbody = document.getElementById('ctTable')
    tbody.innerHTML = ''
    for(const c of list){
      const tr = document.createElement('tr')
      const flag = c.flag_url ? `<img src="${c.flag_url}" alt="${c.code}" style="height:18px">` : ''
      tr.innerHTML = `<td>${c.code}</td><td>${c.name}</td><td>${c.local_name||''}</td><td>${flag}</td>
      <td><button onclick='pickCountry(${JSON.stringify({code:""}).replace("{\"code\":\"\"}",JSON.stringify({code:c.code}).replace(/"/g,'&quot;'))})'>選取</button>
      <button onclick='deleteCountry("${c.code}")'>刪除</button></td>`
      tbody.appendChild(tr)
    }
    log({countries:list.length})
  }catch(e){}
}
async function createCountry(){
  const code = document.getElementById('ctCode').value.trim().toUpperCase()
  const name = document.getElementById('ctName').value.trim()
  const localName = document.getElementById('ctLocalName').value.trim() || null
  const flagUrl = document.getElementById('ctFlagUrl').value.trim() || null
  if(!code || !name){ log('code and name required'); return }
  if(code.length!==3){ log('代碼需為 ISO3（三個字母）'); return }
  try{
    const d = await authedFetch('/api/admin/countries', { method:'POST', body: JSON.stringify({ code, name, localName, flagUrl }) })
    log(d); loadCountries(); loadClubs()
  }catch(e){}
}
function pickCountry(c){
  document.getElementById('ctCode').value = c.code || ''
}
async function updateCountry(){
  const code = document.getElementById('ctCode').value.trim().toUpperCase()
  if(!code){ log('請先輸入或選取代碼'); return }
  const name = document.getElementById('ctName').value.trim() || null
  const localName = document.getElementById('ctLocalName').value.trim() || null
  const flagUrl = document.getElementById('ctFlagUrl').value.trim() || null
  try{
    const d = await authedFetch('/api/admin/countries/'+code, { method:'PUT', body: JSON.stringify({ name, localName, flagUrl }) })
    log(d); loadCountries(); loadClubs()
  }catch(e){}
}
async function deleteCountry(code){
  if(!confirm('確定刪除 '+code+' ?')) return
  try{
    await authedFetch('/api/admin/countries/'+code, { method:'DELETE' })
    log('deleted '+code); loadCountries(); loadClubs()
  }catch(e){}
}
async function uploadFlag(){
  const code = document.getElementById('ctCode').value.trim().toUpperCase()
  const f = document.getElementById('ctFlagFile').files[0]
  if(!code){ log('請先輸入或選取代碼'); return }
  if(!f){ log('請選取圖片'); return }
  try{
    const r = await fetch('/api/admin/countries/'+code+'/flag', { method:'POST', headers: { 'Authorization':'Bearer '+token(), 'Content-Type': f.type }, body: f })
    const d = await r.json()
    log(d); loadCountries()
  }catch(e){ log('upload failed') }
}
updateUI()
</script>
