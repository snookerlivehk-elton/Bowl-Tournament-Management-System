<!doctype html>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>球會後台（Club Admin）</title>
<style>body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:16px}.card{border:1px solid #ddd;border-radius:8px;padding:12px;margin:12px 0}input,button{padding:10px;font-size:16px}button{cursor:pointer}table{border-collapse:collapse;width:100%}th,td{border:1px solid #ddd;padding:8px;text-align:left}#log{background:#0b1020;color:#e8e8e8;border-radius:8px;padding:10px;white-space:pre-wrap}</style>
<h2>球會後台（Club Admin）</h2>
<div class="card">
  <div><label>Token（若未帶入請貼上）</label><br><input id="tokenInput" style="width:100%"></div>
  <div style="margin-top:10px"><button onclick="useToken()">使用 Token</button> <span id="status">未登入</span></div>
</div>
<div class="card" id="profile" style="display:none">
  <h3>球會基本資料</h3>
  <div><label>名稱</label><br><input id="name"></div>
  <div><label>地區（ISO3，可空）</label><br><input id="region"></div>
  <div><label>城市</label><br><input id="city"></div>
  <div><label>地址</label><br><input id="address"></div>
  <div><label>聯絡人</label><br><input id="contactName"></div>
  <div><label>電話</label><br><input id="contactPhone"></div>
  <div><label>Email</label><br><input id="contactEmail"></div>
  <div style="margin-top:10px"><button onclick="saveProfile()">儲存基本資料</button></div>
</div>
<div class="card" id="logo" style="display:none">
  <h3>Logo 管理</h3>
  <div><input type="file" id="logoFile" accept="image/png,image/jpeg,image/webp"> <button onclick="uploadLogo()">上傳 Logo</button></div>
  <div style="margin-top:8px"><img id="logoPreview" style="height:32px"></div>
</div>
<div class="card" id="templates" style="display:none">
  <h3>賽事模板</h3>
  <div>
    <label>名稱</label><br><input id="tplName">
    <div class="row">
      <div><label>模式</label><br><select id="tplMode"><option value="friendly">friendly</option><option value="league">league</option><option value="tournament">tournament</option></select></div>
      <div><label>參賽型態</label><br><select id="tplKind"><option value="single">single</option><option value="double">double</option><option value="team">team</option></select></div>
      <div><label>隊伍人數（team 時）</label><br><input id="tplTeamSize" type="number" min="2" placeholder="可空"></div>
      <div><label>每場局數</label><br><input id="tplFrames" type="number" min="1" value="1"></div>
    </div>
    <div class="row">
      <div><label>球道數</label><br><input id="tplLanes" type="number" min="1" value="4"></div>
      <div><label>參賽上限</label><br><input id="tplLimit" type="number" min="5" value="16"></div>
      <div><label>初賽局數</label><br><input id="tplPrelimGames" type="number" min="1" value="3"></div>
      <div><label>階梯淘汰</label><br><input id="tplStepladder" type="checkbox" checked> Stepladder-5</div>
    </div>
    <div><label>選項 JSON（可空）</label><br><textarea id="tplOptions" rows="4" style="width:100%" placeholder='{"scoring":"standard"}'></textarea></div>
    <div style="margin-top:8px"><button onclick="createTemplate()">新增模板</button></div>
  </div>
  <div style="margin-top:10px">
    <table>
      <thead><tr><th>ID</th><th>名稱</th><th>模式</th><th>型態</th><th>隊伍人數</th><th>局數</th><th>啟用</th><th>操作</th></tr></thead>
      <tbody id="tplTable"></tbody>
    </table>
  </div>
  <div style="margin-top:10px">
    <h4>初賽總分 → 種子</h4>
    <p>格式：每行「playerId,total」，例如「12, 680」</p>
    <textarea id="seedInput" rows="6" style="width:100%" placeholder="12,680&#10;34,720&#10;..."></textarea>
    <div style="margin-top:6px">
      <button onclick="calcSeeds()">計算前五種子</button>
      <input id="assignTplId" placeholder="模板ID（用於指派）" style="width:120px">
      <input id="assignMatchIds" placeholder="matchIds 用逗號分隔（4 個）" style="width:260px">
      <input id="assignSeeds" placeholder="seeds 用逗號分隔（5 個，最高分在前）" style="width:260px">
      <button onclick="assignSeeds()">指派種子到淘汰賽</button>
    </div>
  </div>
</div>
<div class="card" id="competitions" style="display:none">
  <h3>賽事與階段</h3>
  <div class="row">
    <div><label>賽事名稱</label><br><input id="compName"></div>
    <div style="align-self:end"><button onclick="createCompetition()">建立賽事</button></div>
  </div>
  <div style="margin-top:10px">
    <table>
      <thead><tr><th>ID</th><th>名稱</th><th>狀態</th><th>建立</th><th>操作</th></tr></thead>
      <tbody id="compTable"></tbody>
    </table>
  </div>
  <div style="margin-top:14px">
    <h4>新增階段</h4>
    <div class="row">
      <div><label>賽事ID</label><br><input id="stageCompId" placeholder="從上表選取後填入"></div>
      <div><label>順序</label><br><input id="stageSeq" type="number" min="1" value="1"></div>
      <div><label>名稱</label><br><input id="stageName" placeholder="例如 階段一"></div>
      <div><label>賽制</label><br><select id="stageFormat"><option value="stepladder">stepladder</option><option value="league">league</option></select></div>
      <div><label>球道數</label><br><input id="stageLanes" type="number" min="1" value="8"></div>
      <div><label>每場局數</label><br><input id="stageFrames" type="number" min="1" value="12"></div>
      <div><label>Seeds/或每制參數</label><br><input id="stageSeeds" type="number" min="3" value="5"></div>
    </div>
    <div style="margin-top:8px"><button onclick="createStage()">新增階段</button></div>
  </div>
  <div style="margin-top:10px">
    <h4>階段列表</h4>
    <table>
      <thead><tr><th>ID</th><th>Seq</th><th>名稱</th><th>賽制</th><th>狀態</th><th>操作</th></tr></thead>
      <tbody id="stageTable"></tbody>
    </table>
  </div>
</div>
<div class="card"><div id="log">等待操作…</div></div>
<script>
function log(x){document.getElementById('log').textContent=(typeof x==='string')?x:JSON.stringify(x,null,2)}
function tok(){return localStorage.getItem('club_token')||''}
function setTok(t){localStorage.setItem('club_token',t)}
function updateUI(){const t=tok();document.getElementById('status').textContent=t?'已登入':'未登入';document.getElementById('profile').style.display=t?'block':'none';document.getElementById('logo').style.display=t?'block':'none';document.getElementById('templates').style.display=t?'block':'none';document.getElementById('competitions').style.display=t?'block':'none'}
function useToken(){const t=document.getElementById('tokenInput').value.trim();if(!t){log('請貼上 token');return}setTok(t);updateUI();loadProfile()}
async function authedFetch(url,opts){const h=Object.assign({},(opts&&opts.headers)||{}, {'Authorization':'Bearer '+tok(),'Content-Type':'application/json'});const r=await fetch(url,Object.assign({},opts||{}, {headers:h}));if(!r.ok){const txt=await r.text();try{log(JSON.parse(txt))}catch{log(txt)};throw new Error('request failed')}return r.json()}
async function loadProfile(){const d=await authedFetch('/api/club/profile',{method:'GET'});document.getElementById('name').value=d.name||'';document.getElementById('region').value=d.region||'';document.getElementById('city').value=d.city||'';document.getElementById('address').value=d.address||'';document.getElementById('contactName').value=d.contact_name||'';document.getElementById('contactPhone').value=d.contact_phone||'';document.getElementById('contactEmail').value=d.contact_email||'';if(d.logo_url){document.getElementById('logoPreview').src=d.logo_url}}
async function saveProfile(){const body={name:document.getElementById('name').value.trim()||null,region:(document.getElementById('region').value||'').toUpperCase()||null,city:document.getElementById('city').value.trim()||null,address:document.getElementById('address').value.trim()||null,contactName:document.getElementById('contactName').value.trim()||null,contactPhone:document.getElementById('contactPhone').value.trim()||null,contactEmail:document.getElementById('contactEmail').value.trim()||null};const d=await authedFetch('/api/club/profile',{method:'PUT',body:JSON.stringify(body)});log(d);loadProfile()}
async function uploadLogo(){const f=document.getElementById('logoFile').files[0];if(!f){log('請選取圖片');return}const r=await fetch('/api/club/logo',{method:'POST',headers:{'Authorization':'Bearer '+tok(),'Content-Type':f.type},body:f});const d=await r.json();log(d);loadProfile()}
async function loadTemplates(){
  const list=await authedFetch('/api/club/templates',{method:'GET'})
  const tbody=document.getElementById('tplTable')
  tbody.innerHTML=''
  for(const t of list){
    const tr=document.createElement('tr')
    tr.innerHTML=`<td>${t.id}</td><td>${t.name}</td><td>${t.mode}</td><td>${t.participant_kind}</td><td>${t.team_size||''}</td><td>${t.frames_per_match}</td><td>${t.enabled?'Y':'N'}</td><td>
    <button onclick="enableTemplate(${t.id},${t.enabled?'false':'true'})">${t.enabled?'停用':'啟用'}</button>
    <button onclick="deleteTemplate(${t.id})">刪除</button>
    <button onclick="showPlan(${t.id})">查看計畫</button>
    <button onclick="generateMatches(${t.id})">生成賽事骨架</button>
    </td>`
    tbody.appendChild(tr)
  }
  log({templates:list.length})
}
async function createTemplate(){
  const name = document.getElementById('tplName').value.trim()
  if(!name){ log('名稱必填'); return }
  const mode = document.getElementById('tplMode').value
  const participantKind = document.getElementById('tplKind').value
  const teamSize = parseInt(document.getElementById('tplTeamSize').value||'0',10)||null
  const framesPerMatch = parseInt(document.getElementById('tplFrames').value||'1',10)
  const lanes = parseInt(document.getElementById('tplLanes').value||'1',10)
  const limit = parseInt(document.getElementById('tplLimit').value||'5',10)
  const prelimGames = parseInt(document.getElementById('tplPrelimGames').value||'1',10)
  const stepladder = document.getElementById('tplStepladder').checked
  let opts = null
  const txt = document.getElementById('tplOptions').value.trim()
  if (stepladder) {
    opts = {
      lanes,
      participants_limit: limit,
      prelim: { games: prelimGames, scoring: 'standard', tie_breakers: ['last_game_higher'] },
      bracket: { type: 'stepladder', seeds: 5 },
      scheduling: { mode: 'manual', lane_policy: 'sequential' }
    }
  } else if (txt) {
    try{ opts = JSON.parse(txt) } catch(e){ log('選項 JSON 格式錯誤'); return }
  }
  const body = { name, mode, participantKind, teamSize, framesPerMatch, options: opts }
  const d = await authedFetch('/api/club/templates', { method:'POST', body: JSON.stringify(body) })
  log(d); loadTemplates()
}
async function enableTemplate(id,enabled){const d=await authedFetch('/api/club/templates/'+id,{method:'PUT',body:JSON.stringify({enabled})});log(d);loadTemplates()}
async function deleteTemplate(id){await authedFetch('/api/club/templates/'+id,{method:'DELETE'});log('deleted');loadTemplates()}
async function showPlan(id){
  const d=await authedFetch('/api/club/templates/'+id+'/plan',{method:'GET'})
  log(d)
}
async function generateMatches(id){
  const d=await authedFetch('/api/club/templates/'+id+'/generate',{method:'POST'})
  log(d)
}
async function calcSeeds(){
  const tplIdPrompt = prompt('請輸入模板ID（用於存檔 seeds）')
  const lines=document.getElementById('seedInput').value.trim().split(/\r?\n/).filter(Boolean)
  const results=lines.map(l=>{const m=l.split(',');return {playerId:Number(m[0].trim()), total:Number(m[1].trim())}})
  const d=await authedFetch('/api/club/templates/'+Number(tplIdPrompt)+'/seeds',{method:'POST',body:JSON.stringify({results})})
  log(d)
  document.getElementById('assignTplId').value=String(tplIdPrompt||'')
  const s=(d.seeds||[])
  document.getElementById('assignSeeds').value=s.join(',')
}
async function assignSeeds(){
  const tplId=Number(document.getElementById('assignTplId').value||'0')
  const mids=(document.getElementById('assignMatchIds').value||'').split(',').map(x=>Number(x.trim())).filter(Boolean)
  const seeds=(document.getElementById('assignSeeds').value||'').split(',').map(x=>Number(x.trim())).filter(Boolean)
  const d=await authedFetch('/api/club/templates/'+tplId+'/assign-seeds',{method:'POST',body:JSON.stringify({matchIds:mids,seeds})})
  log(d)
}
async function loadCompetitions(){
  const list=await authedFetch('/api/club/competitions',{method:'GET'})
  const tbody=document.getElementById('compTable');tbody.innerHTML=''
  for(const c of list){
    const tr=document.createElement('tr')
    const payload=encodeURIComponent(JSON.stringify(c))
    tr.innerHTML=`<td>${c.id}</td><td>${c.name}</td><td>${c.status}</td><td>${c.created_at||''}</td><td><button onclick="pickCompetition('${payload}')">選取</button></td>`
    tbody.appendChild(tr)
  }
}
let currentCompetitionId = null
function pickCompetition(enc){
  const c=JSON.parse(decodeURIComponent(enc))
  currentCompetitionId=c.id
  document.getElementById('stageCompId').value=String(c.id)
  loadStages()
  log({competition:c})
}
async function createCompetition(){
  const name=document.getElementById('compName').value.trim()
  if(!name){log('名稱必填');return}
  const d=await authedFetch('/api/club/competitions',{method:'POST',body:JSON.stringify({name})})
  log(d); loadCompetitions()
}
async function createStage(){
  const cid=Number(document.getElementById('stageCompId').value||'0')
  if(!cid){log('請先選取賽事');return}
  const body={
    seq:Number(document.getElementById('stageSeq').value||'1'),
    name:document.getElementById('stageName').value.trim()||'階段',
    formatType:document.getElementById('stageFormat').value,
    lanes:Number(document.getElementById('stageLanes').value||'1'),
    framesPerMatch:Number(document.getElementById('stageFrames').value||'1'),
    config:{seeds:Number(document.getElementById('stageSeeds').value||'5')}
  }
  const d=await authedFetch('/api/club/competitions/'+cid+'/stages',{method:'POST',body:JSON.stringify(body)})
  log(d); loadStages()
}
async function loadStages(){
  const cid=Number(document.getElementById('stageCompId').value||'0')
  if(!cid){return}
  const list=await authedFetch('/api/club/competitions/'+cid+'/stages',{method:'GET'})
  const tbody=document.getElementById('stageTable');tbody.innerHTML=''
  for(const s of list){
    const tr=document.createElement('tr')
    tr.innerHTML=`<td>${s.id}</td><td>${s.seq}</td><td>${s.name}</td><td>${s.format_type}</td><td>${s.status}</td><td><button onclick="generateStage(${s.id})">生成骨架</button></td>`
    tbody.appendChild(tr)
  }
}
async function generateStage(id){
  const d=await authedFetch('/api/club/stages/'+id+'/generate',{method:'POST'})
  log(d); loadStages()
}
// 支援兩種帶入方式：#token=... 或 ?token=...
if(location.hash.startsWith('#token=')){const t=location.hash.slice(7);document.getElementById('tokenInput').value=t;setTok(t);updateUI();loadProfile()}
else if(new URLSearchParams(location.search).get('token')){const t=new URLSearchParams(location.search).get('token');document.getElementById('tokenInput').value=t;setTok(t);updateUI();loadProfile()}
updateUI()
window.useToken = useToken
window.saveProfile = saveProfile
window.uploadLogo = uploadLogo
window.createTemplate = createTemplate
window.enableTemplate = enableTemplate
window.deleteTemplate = deleteTemplate
if(tok()){try{loadTemplates()}catch(e){}}
if(tok()){try{loadCompetitions()}catch(e){}}
</script>
