<!doctype html>
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>球會後台（Club Admin）</title>
<style>body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:16px}.card{border:1px solid #ddd;border-radius:8px;padding:12px;margin:12px 0}input,button{padding:10px;font-size:16px}button{cursor:pointer}table{border-collapse:collapse;width:100%}th,td{border:1px solid #ddd;padding:8px;text-align:left}#log{background:#0b1020;color:#e8e8e8;border-radius:8px;padding:10px;white-space:pre-wrap}</style>
<h2>球會後台（Club Admin）</h2>
<div id="nudge" style="display:none;position:fixed;top:10px;left:50%;transform:translateX(-50%);background:#2b6cb0;color:#fff;padding:8px 12px;border-radius:6px;z-index:9999;box-shadow:0 2px 10px rgba(0,0,0,.2);font-size:14px"></div>
<div class="card" id="guide">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <b>操作教學</b>
    <button onclick="toggleGuide()">收合/展開</button>
  </div>
  <ol style="margin-top:8px">
    <li>登入：使用總後台生成的連結進入本頁；網址若包含 token 會自動登入。若未帶入，可將 token 貼到上方欄位，按「使用 Token」。</li>
    <li>建立賽事（推薦新流程）：
      <ul>
        <li>在「賽事與階段」卡片輸入賽事名稱 → 建立賽事 → 在表格按「選取」。</li>
        <li>新增階段：選擇「賽制」後，底下會顯示對應設定表單。</li>
        <li>stepladder：設定 Seeds（人數，取前 N 名依名次排入；例：5 人 → 首場 5 vs 4，勝者對 3 → 對 2 → 對 1）、每場局數、球道數、球道輪換；可選 single/double/team 與隊伍人數。</li>
        <li>league：設定（單/雙）循環、球道輪換、對賽配對（循環/按上週排名）、每局勝/和/負積分、整場總分加成與上限、讓分（是否啟用與每局值）、參賽型態。</li>
        <li>按「新增階段」後，在階段列表按「生成骨架」。stepladder 會建立占位場次；league 會標記為 planned（之後帶名單排程）。</li>
      </ul>
    </li>
    <li>舊流程（模板）：仍可於「賽事模板」卡片使用「計算種子→指派」與骨架；適合單次的階梯淘汰。</li>
    <li>比賽進行：打開 /api/m/:id 錄入每局分數，完成後按 P1勝/P2勝可自動推進（階梯賽）。</li>
  </ol>
  <div style="font-size:12px;opacity:.8">提示：本頁所有請求會自動帶入你的登入 Token，無需手動複製。</div>
  <hr style="margin:10px 0">
  <div>
    <b>欄位說明（聯賽）</b>
    <ul>
      <li>循環次數：單/雙循環</li>
      <li>球道輪換：sequential/蛇形（snake）/對陣輪換（rotate_by_pair）</li>
      <li>對賽配對：round_robin 或 by_last_week_ranking</li>
      <li>每局積分：勝/和/負；整場總分加成：若啟用，整場總分較高者額外得分；每場最高分：限制單場總得分上限（例：5 分）</li>
      <li>讓分：每局固定讓分或不使用；可搭配 team 模式</li>
    </ul>
  </div>
</div>
<div class="card">
  <div><label>Token（可貼純 token 或整個連結）</label><br><input id="tokenInput" style="width:100%"></div>
  <div style="margin-top:10px"><button onclick="useToken()">使用 Token</button> <span id="status">未登入</span></div>
</div>
<div class="card" id="profile" style="display:none">
  <h3>球會基本資料</h3>
  <div><label>名稱</label><br><input id="name"></div>
  <div><label>地區（ISO3，可空）</label><br><input id="region"></div>
  <div><label>城市</label><br><input id="city"></div>
  <div><label>地址</label><br><input id="address"></div>
  <div><label>聯絡人</label><br><input id="contactName"></div>
  <div><label>電話</label><br><input id="contactPhone"></div>
  <div><label>Email</label><br><input id="contactEmail"></div>
  <div style="margin-top:10px"><button onclick="saveProfile()">儲存基本資料</button></div>
</div>
<div class="card" id="logo" style="display:none">
  <h3>Logo 管理</h3>
  <div><input type="file" id="logoFile" accept="image/png,image/jpeg,image/webp"> <button onclick="uploadLogo()">上傳 Logo</button></div>
  <div style="margin-top:8px"><img id="logoPreview" style="height:32px"></div>
</div>
<div class="card" id="templates" style="display:none">
  <h3>賽事模板</h3>
  <div>
    <label>名稱</label><br><input id="tplName">
    <div class="row">
      <div><label>模式</label><br><select id="tplMode"><option value="friendly">friendly</option><option value="league">league</option><option value="tournament">tournament</option></select></div>
      <div><label>參賽型態</label><br><select id="tplKind"><option value="single">single</option><option value="double">double</option><option value="team">team</option></select></div>
      <div><label>隊伍人數（team 時）</label><br><input id="tplTeamSize" type="number" min="2" placeholder="可空"></div>
      <div><label>每場局數</label><br><input id="tplFrames" type="number" min="1" value="1"></div>
    </div>
    <div class="row">
      <div><label>球道數</label><br><input id="tplLanes" type="number" min="1" value="4"></div>
      <div><label>參賽上限</label><br><input id="tplLimit" type="number" min="5" value="16"></div>
      <div><label>初賽局數</label><br><input id="tplPrelimGames" type="number" min="1" value="3"></div>
      <div><label>階梯淘汰</label><br><input id="tplStepladder" type="checkbox" checked> Stepladder-5</div>
    </div>
    <div><label>選項 JSON（可空）</label><br><textarea id="tplOptions" rows="4" style="width:100%" placeholder='{"scoring":"standard"}'></textarea></div>
    <div style="margin-top:8px"><button onclick="createTemplate()">新增模板</button></div>
  </div>
  <div style="margin-top:10px">
    <table>
      <thead><tr><th>ID</th><th>名稱</th><th>模式</th><th>型態</th><th>隊伍人數</th><th>局數</th><th>啟用</th><th>操作</th></tr></thead>
      <tbody id="tplTable"></tbody>
    </table>
  </div>
  <!-- 舊版模板與種子工具已移至賽事/階段下方的「階梯種子工具」，這裡保留隱藏開關 -->
</div>
<div style="margin:8px 0">
  <button onclick="toggleTemplates()">顯示/隱藏舊版模板工具</button>
  <span style="font-size:12px;opacity:.7">（建議改用「賽事與階段」）</span>
</div>
<div class="card" id="competitions" style="display:none">
  <h3>賽事與階段</h3>
  <div id="compNotice" style="display:none;color:#b00020;margin:6px 0">尚未登入或 Token 已失效，請先在上方貼入 Token 並按「使用 Token」。</div>
  <div class="row">
    <div><label>賽事名稱</label><br><input id="compName"></div>
    <div style="align-self:end"><button id="btnCreateComp" onclick="createCompetition()">建立賽事</button></div>
  </div>
  <div style="margin-top:10px">
    <table>
      <thead><tr><th>ID</th><th>名稱</th><th>狀態</th><th>建立</th><th>操作</th></tr></thead>
      <tbody id="compTable"></tbody>
    </table>
  </div>
  <div style="margin-top:14px">
    <h4 id="stageFormAnchor">新增階段</h4>
    <div class="row">
      <div><label>賽事ID</label><br><input id="stageCompId" placeholder="系統自動帶入" readonly></div>
      <div><label>順序</label><br><input id="stageSeq" type="number" min="1" value="1"></div>
      <div><label>名稱</label><br><input id="stageName" placeholder="例如 階段一"></div>
      <div><label>賽制</label><br><select id="stageFormat" onchange="renderStageConfig()"><option value="stepladder">stepladder</option><option value="league">league</option></select></div>
      <div><label>球道數</label><br><input id="stageLanes" type="number" min="1" value="8"></div>
      <div><label>每場局數</label><br><input id="stageFrames" type="number" min="1" value="12"></div>
      <div><label>參賽型態</label><br><select id="stageKind"><option value="single">single</option><option value="double">double</option><option value="team">team</option></select></div>
      <div><label>隊伍人數（team）</label><br><input id="stageTeamSize" type="number" min="2" value="3"></div>
    </div>
    <div id="cfg-stepladder" class="row" style="margin-top:8px">
      <div><label title="階梯淘汰取前 N 名依名次排入，需 N≥3">Seeds（人數）</label><br><input id="stageSeeds" type="number" min="3" value="5"><div style="font-size:12px;opacity:.75;margin-top:4px">取前 N 名；例：5 人 → 首場 5 vs 4，勝者對 3 → 對 2 → 對 1</div></div>
      <div><label>球道輪換</label><br><select id="stageLanePolicy"><option value="sequential">sequential</option><option value="snake">snake</option><option value="rotate_by_pair">rotate_by_pair</option></select></div>
    </div>
    <div id="cfg-league" style="display:none;margin-top:8px">
      <div class="row">
        <div><label>循環次數</label><br><select id="lgRounds"><option value="1">單循環</option><option value="2">雙循環</option></select></div>
        <div><label>球道輪換</label><br><select id="lgLanePolicy"><option value="sequential">sequential</option><option value="snake">snake</option><option value="rotate_by_pair">rotate_by_pair</option></select></div>
        <div><label>對賽配對</label><br><select id="lgPairing"><option value="round_robin">round_robin</option><option value="by_last_week_ranking">by_last_week_ranking</option></select></div>
      </div>
      <div style="margin-top:6px"><b>積分規則</b></div>
      <div class="row">
        <div><label>每局：勝</label><br><input id="lgWin" type="number" step="0.5" value="1"></div>
        <div><label>每局：和</label><br><input id="lgDraw" type="number" step="0.5" value="0.5"></div>
        <div><label>每局：負</label><br><input id="lgLoss" type="number" step="0.5" value="0"></div>
        <div><label>整場總分加成</label><br>
          <select id="lgMatchBonusEnable"><option value="true">啟用</option><option value="false">停用</option></select>
        </div>
        <div><label>加成分</label><br><input id="lgMatchBonusPts" type="number" step="0.5" value="1"></div>
        <div><label>每場最高分</label><br><input id="lgMaxPts" type="number" step="0.5" value="5"></div>
      </div>
      <div style="margin-top:6px"><b>讓分</b></div>
      <div class="row">
        <div><label>啟用讓分</label><br><select id="lgHcpEnable"><option value="false">否</option><option value="true">是</option></select></div>
        <div><label>讓分方式</label><br><select id="lgHcpType"><option value="per_game_fixed">每局固定</option><option value="none">不使用</option></select></div>
        <div><label>每局讓分</label><br><input id="lgHcpValue" type="number" value="0"></div>
      </div>
    </div>
    <div style="margin-top:8px"><button id="btnCreateStage" onclick="createStage()">新增階段</button></div>
  </div>
  <div style="margin-top:10px">
    <h4>階段列表</h4>
    <table>
      <thead><tr><th>ID</th><th>Seq</th><th>名稱</th><th>賽制</th><th>狀態</th><th>操作</th></tr></thead>
      <tbody id="stageTable"></tbody>
    </table>
  </div>
  <div style="margin-top:14px" id="stageSeedTools" hidden>
    <h4>階梯種子工具（選取階段後）</h4>
    <div class="row">
      <div><label>階段ID</label><br><input id="seedStageId" readonly></div>
      <div><label>matchIds</label><br><input id="seedStageMatchIds" style="width:300px" placeholder="自動帶入，可修改"></div>
    </div>
    <div style="margin-top:6px">
      <label>貼入初賽總分（每行 playerId,total）</label>
      <textarea id="seedStageInput" rows="6" style="width:100%" placeholder="12,680&#10;34,720&#10;..."></textarea>
    </div>
    <div style="margin-top:6px">
      <button onclick="stageCalcSeeds()">計算前五種子</button>
      <input id="seedStageSeeds" placeholder="seeds 5 個，最高分在前" style="width:260px">
      <button onclick="stageAssignSeeds()">指派種子到淘汰賽</button>
    </div>
  </div>
  <div style="margin-top:14px" id="stageLeagueTools" hidden>
    <h4>聯賽工具（選取聯賽階段後）</h4>
    <div style="margin-top:6px">
      <label>參賽名單（每行 playerId）</label>
      <textarea id="lgPlayers" rows="6" style="width:100%" placeholder="12&#10;34&#10;57&#10;..."></textarea>
      <div style="margin-top:6px">
        <button onclick="saveParticipants()">儲存參賽名單</button>
        <span style="margin-left:6px">開始日期</span> <input id="lgStartDate" type="date">
        <span>開球時間</span> <input id="lgStartTime" type="time" value="09:00">
        <button onclick="generateLeagueSchedule()">生成聯賽賽程</button>
        <button onclick="loadSchedule()">查看賽程</button>
        <button onclick="loadStandings()">查看積分榜</button>
        <button onclick="loadStats()">查看個人統計</button>
      </div>
      <div style="margin-top:6px">
        <label>沒有 playerId？快速產生測試名單</label>
        <div class="row">
          <div><label>人數</label><br><input id="lgMockCount" type="number" min="2" value="4"></div>
          <div><label>起始ID</label><br><input id="lgMockBase" type="number" value="1001"></div>
          <div style="align-self:end"><button onclick="mockParticipants()">生成測試名單</button></div>
        </div>
      </div>
    </div>
    <div style="margin-top:10px">
      <h5>賽程</h5>
      <table>
        <thead><tr><th>Round</th><th>Match</th><th>Lane</th><th>Slot / Date</th><th>對陣</th><th>操作</th></tr></thead>
        <tbody id="scheduleTable"></tbody>
      </table>
    </div>
    <div style="margin-top:10px">
      <h5>回合控制</h5>
      <button onclick="loadRounds()">載入回合摘要</button>
      <table style="margin-top:6px">
        <thead><tr><th>Round</th><th>總場次</th><th>有記分</th><th>狀態</th><th>操作</th></tr></thead>
        <tbody id="roundsTable"></tbody>
      </table>
    </div>
    <div style="margin-top:10px">
      <h5>積分榜</h5>
      <table>
        <thead><tr><th>名次</th><th>Player</th><th>Points</th><th>Matches</th><th>Frames W-D-L</th><th>Pinfall</th></tr></thead>
        <tbody id="standingsTable"></tbody>
      </table>
    </div>
    <div style="margin-top:10px">
      <h5>個人統計</h5>
      <table>
        <thead><tr><th>Player</th><th>Best Match</th><th>Best Frame</th><th>Total Pin</th><th>Avg/Frame</th><th>Matches</th><th>Games</th></tr></thead>
        <tbody id="statsTable"></tbody>
      </table>
    </div>
  </div>
</div>
<div class="card"><div id="log">等待操作…</div></div>
<script>
function log(x){document.getElementById('log').textContent=(typeof x==='string')?x:JSON.stringify(x,null,2)}
function tok(){return localStorage.getItem('club_token')||''}
function setTok(t){localStorage.setItem('club_token',t)}
function updateUI(){
  const t=tok();
  document.getElementById('status').textContent=t?'已登入':'未登入';
  document.getElementById('profile').style.display=t?'block':'none';
  document.getElementById('logo').style.display=t?'block':'none';
  document.getElementById('competitions').style.display=t?'block':'none';
  const notice=document.getElementById('compNotice'); if(notice) notice.style.display=t?'none':'block';
  const btn1=document.getElementById('btnCreateComp'); if(btn1) btn1.disabled=!t;
  const btn2=document.getElementById('btnCreateStage'); if(btn2) btn2.disabled=!t;
}
function useToken(){
  let v=document.getElementById('tokenInput').value.trim();
  if(!v){log('請貼上 token 或含 token 的連結');return}
  let t=v;
  try{
    if(v.includes('token=')){
      if(v.includes('#token=')){ t=v.split('#token=')[1] }
      else { const u=new URL(v); t=u.searchParams.get('token')||v }
    }
  }catch(e){}
  setTok(t); updateUI(); loadProfile(); try{loadCompetitions()}catch(e){}
}
async function authedFetch(url,opts){
  const h=Object.assign({},(opts&&opts.headers)||{}, {'Authorization':'Bearer '+tok(),'Content-Type':'application/json'})
  const r=await fetch(url,Object.assign({},opts||{}, {headers:h}))
  if(r.status===401){
    alert('尚未登入或 Token 已失效，請在頂部貼入 Token 並按「使用 Token」')
    localStorage.removeItem('club_token'); updateUI()
    throw new Error('unauthorized')
  }
  if(!r.ok){
    const txt=await r.text(); try{log(JSON.parse(txt))}catch{log(txt)}; throw new Error('request failed')
  }
  return r.json()
}
async function loadProfile(){const d=await authedFetch('/api/club/profile',{method:'GET'});document.getElementById('name').value=d.name||'';document.getElementById('region').value=d.region||'';document.getElementById('city').value=d.city||'';document.getElementById('address').value=d.address||'';document.getElementById('contactName').value=d.contact_name||'';document.getElementById('contactPhone').value=d.contact_phone||'';document.getElementById('contactEmail').value=d.contact_email||'';if(d.logo_url){document.getElementById('logoPreview').src=d.logo_url}}
async function saveProfile(){const body={name:document.getElementById('name').value.trim()||null,region:(document.getElementById('region').value||'').toUpperCase()||null,city:document.getElementById('city').value.trim()||null,address:document.getElementById('address').value.trim()||null,contactName:document.getElementById('contactName').value.trim()||null,contactPhone:document.getElementById('contactPhone').value.trim()||null,contactEmail:document.getElementById('contactEmail').value.trim()||null};const d=await authedFetch('/api/club/profile',{method:'PUT',body:JSON.stringify(body)});log(d);loadProfile()}
async function uploadLogo(){const f=document.getElementById('logoFile').files[0];if(!f){log('請選取圖片');return}const r=await fetch('/api/club/logo',{method:'POST',headers:{'Authorization':'Bearer '+tok(),'Content-Type':f.type},body:f});const d=await r.json();log(d);loadProfile()}
async function loadTemplates(){
  const list=await authedFetch('/api/club/templates',{method:'GET'})
  const tbody=document.getElementById('tplTable')
  tbody.innerHTML=''
  for(const t of list){
    const tr=document.createElement('tr')
    tr.innerHTML=`<td>${t.id}</td><td>${t.name}</td><td>${t.mode}</td><td>${t.participant_kind}</td><td>${t.team_size||''}</td><td>${t.frames_per_match}</td><td>${t.enabled?'Y':'N'}</td><td>
    <button onclick="enableTemplate(${t.id},${t.enabled?'false':'true'})">${t.enabled?'停用':'啟用'}</button>
    <button onclick="deleteTemplate(${t.id})">刪除</button>
    <button onclick="showPlan(${t.id})">查看計畫</button>
    <button onclick="generateMatches(${t.id})">生成賽事骨架</button>
    </td>`
    tbody.appendChild(tr)
  }
  log({templates:list.length})
}
async function createTemplate(){
  const name = document.getElementById('tplName').value.trim()
  if(!name){ log('名稱必填'); return }
  const mode = document.getElementById('tplMode').value
  const participantKind = document.getElementById('tplKind').value
  const teamSize = parseInt(document.getElementById('tplTeamSize').value||'0',10)||null
  const framesPerMatch = parseInt(document.getElementById('tplFrames').value||'1',10)
  const lanes = parseInt(document.getElementById('tplLanes').value||'1',10)
  const limit = parseInt(document.getElementById('tplLimit').value||'5',10)
  const prelimGames = parseInt(document.getElementById('tplPrelimGames').value||'1',10)
  const stepladder = document.getElementById('tplStepladder').checked
  let opts = null
  const txt = document.getElementById('tplOptions').value.trim()
  if (stepladder) {
    opts = {
      lanes,
      participants_limit: limit,
      prelim: { games: prelimGames, scoring: 'standard', tie_breakers: ['last_game_higher'] },
      bracket: { type: 'stepladder', seeds: 5 },
      scheduling: { mode: 'manual', lane_policy: 'sequential' }
    }
  } else if (txt) {
    try{ opts = JSON.parse(txt) } catch(e){ log('選項 JSON 格式錯誤'); return }
  }
  const body = { name, mode, participantKind, teamSize, framesPerMatch, options: opts }
  const d = await authedFetch('/api/club/templates', { method:'POST', body: JSON.stringify(body) })
  log(d); loadTemplates()
}
async function enableTemplate(id,enabled){const d=await authedFetch('/api/club/templates/'+id,{method:'PUT',body:JSON.stringify({enabled})});log(d);loadTemplates()}
async function deleteTemplate(id){await authedFetch('/api/club/templates/'+id,{method:'DELETE'});log('deleted');loadTemplates()}
async function showPlan(id){
  const d=await authedFetch('/api/club/templates/'+id+'/plan',{method:'GET'})
  log(d)
}
async function generateMatches(id){
  const d=await authedFetch('/api/club/templates/'+id+'/generate',{method:'POST'})
  log(d)
}
async function loadCompetitions(){
  const list=await authedFetch('/api/club/competitions',{method:'GET'})
  const tbody=document.getElementById('compTable');tbody.innerHTML=''
  for(const c of list){
    const tr=document.createElement('tr')
    const payload=encodeURIComponent(JSON.stringify(c))
    tr.innerHTML=`<td>${c.id}</td><td>${c.name}</td><td>${c.status}</td><td>${c.created_at||''}</td><td><button onclick="pickCompetition('${payload}')">選取</button></td>`
    tbody.appendChild(tr)
  }
}
let currentCompetitionId = null
function pickCompetition(enc){
  const c=JSON.parse(decodeURIComponent(enc))
  currentCompetitionId=c.id
  document.getElementById('stageCompId').value=String(c.id)
  loadStages()
  scrollToStageForm()
  nudge('已選取賽事，請在下方新增階段')
  log({competition:c})
}
async function createCompetition(){
  const name=document.getElementById('compName').value.trim()
  if(!name){log('名稱必填');return}
  const d=await authedFetch('/api/club/competitions',{method:'POST',body:JSON.stringify({name})})
  log(d);
  currentCompetitionId = d.id
  document.getElementById('stageCompId').value=String(d.id)
  await loadCompetitions()
  await loadStages()
  scrollToStageForm()
  nudge('賽事已建立，已帶入賽事ID，請新增階段')
}
async function createStage(){
  const cid=Number(document.getElementById('stageCompId').value||'0')
  if(!cid){log('請先選取賽事');return}
  const format=document.getElementById('stageFormat').value
  const body={
    seq:Number(document.getElementById('stageSeq').value||'1'),
    name:document.getElementById('stageName').value.trim()||'階段',
    formatType:format,
    lanes:Number(document.getElementById('stageLanes').value||'1'),
    framesPerMatch:Number(document.getElementById('stageFrames').value||'1'),
    config:{},
    advancement:null
  }
  const kind=document.getElementById('stageKind').value
  const teamSize=Number(document.getElementById('stageTeamSize').value||'0')
  if(format==='stepladder'){
    body.config={seeds:Number(document.getElementById('stageSeeds').value||'5'), lane_policy:document.getElementById('stageLanePolicy').value, participant_kind:kind, team_size:teamSize||null}
  }else if(format==='league'){
    body.config={
      rounds:Number(document.getElementById('lgRounds').value||'1'),
      lane_policy:document.getElementById('lgLanePolicy').value,
      pairing_policy:document.getElementById('lgPairing').value,
      participant_kind:kind,
      team_size:teamSize||null,
      scoring:{
        per_game:{ win:Number(document.getElementById('lgWin').value||'1'), draw:Number(document.getElementById('lgDraw').value||'0.5'), loss:Number(document.getElementById('lgLoss').value||'0') },
        match_total_bonus:{ enabled:(document.getElementById('lgMatchBonusEnable').value==='true'), points:Number(document.getElementById('lgMatchBonusPts').value||'1') },
        max_match_points:Number(document.getElementById('lgMaxPts').value||'5')
      },
      handicap:{
        enabled:(document.getElementById('lgHcpEnable').value==='true'),
        type:document.getElementById('lgHcpType').value,
        value:Number(document.getElementById('lgHcpValue').value||'0')
      }
    }
  }
  const d=await authedFetch('/api/club/competitions/'+cid+'/stages',{method:'POST',body:JSON.stringify(body)})
  log(d); loadStages()
}
function scrollToStageForm(){ const el=document.getElementById('stageFormAnchor'); if(el){ el.scrollIntoView({behavior:'smooth',block:'start'}) } }
function nudge(msg){ const n=document.getElementById('nudge'); if(!n) return; n.textContent = msg; n.style.display='block'; clearTimeout(window.__nudgeTimer); window.__nudgeTimer=setTimeout(()=>{n.style.display='none'},3000) }
async function loadStages(){
  const cid=Number(document.getElementById('stageCompId').value||'0')
  if(!cid){return}
  const list=await authedFetch('/api/club/competitions/'+cid+'/stages',{method:'GET'})
  const tbody=document.getElementById('stageTable');tbody.innerHTML=''
  for(const s of list){
    const tr=document.createElement('tr')
    tr.innerHTML=`<td>${s.id}</td><td>${s.seq}</td><td>${s.name}</td><td>${s.format_type}</td><td>${s.status}</td><td><button onclick="generateStage(${s.id})">生成骨架</button> ${s.format_type==='stepladder'?`<button onclick="openStageSeed(${s.id})">種子工具</button>`:`<button onclick="openLeagueTools(${s.id})">聯賽工具</button>`}</td>`
    tbody.appendChild(tr)
  }
}
async function generateStage(id){
  const d=await authedFetch('/api/club/stages/'+id+'/generate',{method:'POST'})
  log(d); loadStages()
}
async function openStageSeed(id){
  document.getElementById('stageSeedTools').hidden=false
  document.getElementById('seedStageId').value=String(id)
  // 嘗試從列表再取一次資訊取得 matchIds
  const cid=Number(document.getElementById('stageCompId').value||'0')
  const list=await authedFetch('/api/club/competitions/'+cid+'/stages',{method:'GET'})
  const s=list.find(x=>x.id===id)
  const mids=(s?.config?.bracket?.matchIds)||(s?.config?.generated_match_ids)||[]
  document.getElementById('seedStageMatchIds').value=(mids||[]).join(',')
}
async function stageCalcSeeds(){
  const id=Number(document.getElementById('seedStageId').value||'0')
  const lines=document.getElementById('seedStageInput').value.trim().split(/\r?\n/).filter(Boolean)
  const results=lines.map(l=>{const m=l.split(',');return {playerId:Number(m[0].trim()), total:Number(m[1].trim())}})
  const d=await authedFetch('/api/club/stages/'+id+'/seeds',{method:'POST',body:JSON.stringify({results})})
  log(d); document.getElementById('seedStageSeeds').value=(d.seeds||[]).join(',')
}
async function stageAssignSeeds(){
  const id=Number(document.getElementById('seedStageId').value||'0')
  const seeds=(document.getElementById('seedStageSeeds').value||'').split(',').map(x=>Number(x.trim())).filter(Boolean)
  const d=await authedFetch('/api/club/stages/'+id+'/assign-seeds',{method:'POST',body:JSON.stringify({seeds})})
  log(d)
}
async function openLeagueTools(id){
  document.getElementById('stageLeagueTools').hidden=false
  document.getElementById('seedStageId').value=String(id)
  const ps=await authedFetch('/api/club/stages/'+id+'/participants',{method:'GET'})
  document.getElementById('lgPlayers').value=(ps||[]).join('\n')
}
async function saveParticipants(){
  const id=Number(document.getElementById('seedStageId').value||'0')
  const raw=(document.getElementById('lgPlayers').value||'')
  const normalized=raw.replace(/\\r?\\n/g,'\n') // 將字面「\n」轉為真正換行
  const ids=normalized.split(/\r?\n/).map(x=>Number(x.trim())).filter(v=>Number.isFinite(v)&&v>0)
  const d=await authedFetch('/api/club/stages/'+id+'/participants',{method:'POST',body:JSON.stringify({playerIds:ids})})
  log(d)
}
async function generateLeagueSchedule(){
  const id=Number(document.getElementById('seedStageId').value||'0')
  const startDate=(document.getElementById('lgStartDate')&&document.getElementById('lgStartDate').value)||                                                                 null
  const startTime=(document.getElementById('lgStartTime')&&document.getElementById('lgStartTime').value)||'09:00'
  const payload = startDate ? { startDate, startTime } : {}
  const d=await authedFetch('/api/club/stages/'+id+'/schedule/round-robin',{method:'POST',body:JSON.stringify(payload)})
  log(d); loadSchedule()
}
async function mockParticipants(){
  const id=Number(document.getElementById('seedStageId').value||'0')
  const count=Number(document.getElementById('lgMockCount').value||'4')
  const base=Number(document.getElementById('lgMockBase').value||'1001')
  const d=await authedFetch('/api/club/stages/'+id+'/participants/mock',{method:'POST',body:JSON.stringify({count,base})})
  log(d); document.getElementById('lgPlayers').value=(d.playerIds||[]).join('\n')
}
async function loadSchedule(){
  const id=Number(document.getElementById('seedStageId').value||'0')
  const list=await authedFetch('/api/club/stages/'+id+'/matches',{method:'GET'})
  const tb=document.getElementById('scheduleTable'); tb.innerHTML=''
  for(const m of list){
    const lane=(m.slot_info&&m.slot_info.lane)||''
    const slot=(m.slot_info&&m.slot_info.slot)!=null?m.slot_info.slot:''
    const date=(m.slot_info&&m.slot_info.date)? new Date(m.slot_info.date).toLocaleString(): ''
    const vs=(m.player_ids||[]).join(' vs ')
    const tr=document.createElement('tr')
    tr.innerHTML=`<td>${m.round_no||''}</td><td>#${m.match_id}</td><td>${lane}</td><td>${slot}${date?(' / '+date):''}</td><td>${vs}</td><td><a href="/api/m/${m.match_id}" target="_blank">打開</a></td>`
    tb.appendChild(tr)
  }
}
async function loadStandings(){
  const id=Number(document.getElementById('seedStageId').value||'0')
  const list=await authedFetch('/api/club/stages/'+id+'/standings',{method:'GET'})
  const tb=document.getElementById('standingsTable'); tb.innerHTML=''
  for(const s of list){
    const tr=document.createElement('tr')
    tr.innerHTML=`<td>${s.rank}</td><td>${s.playerId}</td><td>${s.points}</td><td>${s.matches}</td><td>${s.frames_w}-${s.frames_d}-${s.frames_l}</td><td>${s.pinfall}</td>`
    tb.appendChild(tr)
  }
}
async function loadRounds(){
  const id=Number(document.getElementById('seedStageId').value||'0')
  const data=await authedFetch('/api/club/stages/'+id+'/rounds',{method:'GET'})
  const tb=document.getElementById('roundsTable'); tb.innerHTML=''
  for(const r of (data.rounds||[])){
    const tr=document.createElement('tr')
    const ops = `<button onclick="openRound(${r.round})">開放</button> <button onclick="completeRound(${r.round})">完成</button>`
    tr.innerHTML=`<td>${r.round}${r.current?' (current)':''}</td><td>${r.total}</td><td>${r.withFrames}</td><td>${r.status}</td><td>${ops}</td>`
    tb.appendChild(tr)
  }
}
async function openRound(r){
  const id=Number(document.getElementById('seedStageId').value||'0')
  const d=await authedFetch(`/api/club/stages/${id}/rounds/${r}/open`,{method:'POST'})
  log(d); loadRounds()
}
async function completeRound(r){
  const id=Number(document.getElementById('seedStageId').value||'0')
  const d=await authedFetch(`/api/club/stages/${id}/rounds/${r}/complete`,{method:'POST'})
  log(d); loadStandings(); loadRounds()
}
async function loadStats(){
  const id=Number(document.getElementById('seedStageId').value||'0')
  const list=await authedFetch('/api/club/stages/'+id+'/stats',{method:'GET'})
  const tb=document.getElementById('statsTable'); tb.innerHTML=''
  for(const s of list){
    const tr=document.createElement('tr')
    tr.innerHTML=`<td>${s.playerId}</td><td>${s.best_match_total}</td><td>${s.best_frame_score}</td><td>${s.pinfall_total}</td><td>${(s.average_per_frame||0).toFixed(2)}</td><td>${s.matches}</td><td>${s.games}</td>`
    tb.appendChild(tr)
  }
}
// 支援兩種帶入方式：#token=... 或 ?token=...
if(location.hash.startsWith('#token=')){const t=location.hash.slice(7);document.getElementById('tokenInput').value=t;setTok(t);updateUI();loadProfile()}
else if(new URLSearchParams(location.search).get('token')){const t=new URLSearchParams(location.search).get('token');document.getElementById('tokenInput').value=t;setTok(t);updateUI();loadProfile()}
updateUI()
window.useToken = useToken
window.saveProfile = saveProfile
window.uploadLogo = uploadLogo
window.createTemplate = createTemplate
window.enableTemplate = enableTemplate
window.deleteTemplate = deleteTemplate
if(tok()){try{loadTemplates()}catch(e){}}
if(tok()){try{loadCompetitions()}catch(e){}}
function renderStageConfig(){
  const f=document.getElementById('stageFormat').value
  document.getElementById('cfg-stepladder').style.display=(f==='stepladder')?'flex':'none'
  document.getElementById('cfg-league').style.display=(f==='league')?'block':'none'
}
renderStageConfig()
function toggleGuide(){
  const g=document.getElementById('guide')
  const hidden=g.getAttribute('data-hide')==='1'
  if(hidden){
    g.setAttribute('data-hide','0'); g.style.display='block'; localStorage.removeItem('club_guide_hide')
  }else{
    g.setAttribute('data-hide','1'); g.style.display='none'; localStorage.setItem('club_guide_hide','1')
  }
}
if(localStorage.getItem('club_guide_hide')==='1'){
  const g=document.getElementById('guide'); g.setAttribute('data-hide','1'); g.style.display='none'
}
function toggleTemplates(){
  const el=document.getElementById('templates')
  const show = el.style.display==='none'
  el.style.display = show ? 'block' : 'none'
  if(show){ localStorage.setItem('club_templates_show','1') } else { localStorage.removeItem('club_templates_show') }
}
// 初始隱藏舊版模板，除非使用者手動打開過
document.getElementById('templates').style.display = localStorage.getItem('club_templates_show')==='1' ? 'block' : 'none'
</script>
